<?php
/**
 * YAWIK
 *
 * @filesource
 * @license MIT
 * @copyright  2013 - 2018 Cross Solution <http://cross-solution.de>
 *
 * Variables:
 *             $job         JobInterface    Job Entity
 *             $isVisited   bool            Has the user already visited this job in the current session
 */

// meta data
$this->headTitle($this->metaTitle);
$this->headMeta()->setName('description', $this->translate($this->metaDescription))->setAutoEscape(false);

// check for preview
$routeParams = $this->params()->fromRoute();
$preview = false;
if (isset($routeParams['isPreview']) && $routeParams['isPreview']) {
    $preview = true;
}
if ($this->isIntern):
         $this->headMeta()->setName('robots', 'index,follow');
//  elseif(!$this->isIntern):
elseif(!$this->isIntern && !$this->isEmbeddable):
          $this->headMeta()->setName('robots', 'noindex,nofollow');
endif;

// organisation values
$org = $job->getOrganization();
$orgIsDisabled = false;
$orgName = $this->jobOrganizationName($this->job);
if ($org && (Organizations\Entity\Organization::PROFILE_DISABLED == $org->getProfileSetting() || is_null($org->getProfileSetting()) )) {
    $orgIsDisabled = true;
}

$isExpired = ($this->job->getStatus()) ? $this->job->getStatus()->getName() == \Jobs\Entity\StatusInterface::EXPIRED : false;

// pagination values
$container = new \Zend\Session\Container('gastro24_jobboardcontainer');
$lastSearchQuery = $container->landingPageSearchQuery;
$searchTerm = $container->searchTerm;
$hasSession = count($container->getArrayCopy());

if($container->fromCompanyProfile && $container->companyName) {
    $backTitle = $container->companyName . ' Jobs';
    $lastSearchQueryUrl = $this->orgProfileUrl($org) . '?clear=1';
}
elseif (!$lastSearchQuery) {
    $lastSearchQueryUrl = ($container->fromCompanyProfile) ? '/de/jobs?clear=1' : $this->url('lang/jobboard', [], ['query'=> ['q' => $searchTerm]], true);
    $backTitle = $this->translate('Back to search');
}
else {
    $lastSearchQueryUrl = $this->url('lang/landingPage', ['q' => $container->landingPageTerm, 'format' => 'html' ], true);
    $backTitle = $this->translate($lastSearchQuery . ' Jobs');
}

// banner image
if (!$this->isIntern && $this->isEmbeddable) {
    $template = $this->job->getAttachedEntity('gastro24-template');
    $hasBanner = $template && ($image = $template->getImage());
    $imageServerUrl = $this->basePath('modules/Gastro24/images/bg_placeholder_blue.svg');
    if ($hasBanner) {
        $serverUrl = new \Zend\View\Helper\ServerUrl();
        $imageServerUrl = $serverUrl($this->basePath($image->getUri()));
    }
}

// get logo url
$defaultLogoUrl = $this->basePath('modules/Gastro24/images/no-company-logo.png');
$logoUrl = $this->gastroLogoUri($this->job);
if (!$logoUrl) {
    $logoUrl = $defaultLogoUrl;
}

$link = $this->job->getLink();
$industries = $job->getClassifications()->getIndustries();

//if (!$link) {
//    $link = $this->jobUrl($job, ['preview' => true, 'linkOnly' => true]);
//    $this->isEmbeddable = true;
//}

if (!$this->isIntern && !$this->isVisited && !$this->isEmbeddable):
$this->headScript()->captureStart();?>
;(function($, w) {
    $(function() {
        w.setTimeout(
            function() { w.location.href='<?=$this->job->getLink()?>'; },
            3000
        );
    });
})(jQuery, window);
<?php $this->headScript()->captureEnd();
endif;

$this->headScript()->appendFile($this->basePath($this->asset('modules/Gastro24/js/jobs.js')))
    ->appendFile($this->basePath('/dist/js/bootstrap-dialog.min.js'))
    ->appendFile($this->basePath('/dist/js/iframeResizer.js'))
    ->appendFile($this->basePath('/dist/js/iframeResizer.contentWindow.min.js'));
?>

<!-- prev / next navigation -->
<?php if (!$preview) : ?>
    <?php echo $this->partial('jobs/partials/navigation.phtml', [
        'hasSession' => $hasSession,
        'backTitle' => $backTitle,
        'lastSearchQueryUrl' => $lastSearchQueryUrl,
        'prevJob' => $this->prevJob,
        'nextJob' => $this->nextJob,
    ]);
    ?>
<?php endif; ?>
<!-- end prev / next navigation -->

<div class="row">
    <div class="col-md-12">
        <?php if (!$this->isIntern && $this->isVisited && !$this->isEmbeddable): ?>

        <?php elseif (!$this->isIntern && !$this->isEmbeddable): ?>

            <style>

         .spinner {
          margin: 0 auto;
          width: 70px;
          text-align: center;
        }

        .spinner > div {
          width: 18px;
          height: 18px;
          background-color: #333;

          border-radius: 100%;
          display: inline-block;
          -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
          animation: sk-bouncedelay 1.4s infinite ease-in-out both;
        }

        .spinner .bounce1 {
          -webkit-animation-delay: -0.32s;
          animation-delay: -0.32s;
        }

        .spinner .bounce2 {
          -webkit-animation-delay: -0.16s;
          animation-delay: -0.16s;
        }

        @-webkit-keyframes sk-bouncedelay {
          0%, 80%, 100% { -webkit-transform: scale(0) }
          40% { -webkit-transform: scale(1.0) }
        }

        @keyframes sk-bouncedelay {
          0%, 80%, 100% {
            -webkit-transform: scale(0);
            transform: scale(0);
          } 40% {
            -webkit-transform: scale(1.0);
            transform: scale(1.0);
          }
        }

        </style>
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="spinner">
                        <div class="bounce1"></div>
                        <div class="bounce2"></div>
                        <div class="bounce3"></div>
                     </div>
                     <br /><br />
                     <p style="text-align:center;">Sie werden in Kürze automatisch auf das Job-Inserat von <?=$orgName?> weitergeleitet...</p>
                </div>
            </div>
        <?php endif ?>

        <!-- not intern and embedded -->
        <?php if (!$this->isIntern && $this->isEmbeddable):?>

            <style>
            #preload {
            background-color:#fff;
            padding:100px 0;
            }
            .frame-content {
            width: 100%;
            }
            .frame-content iframe {

            background-color:#fff;
            /*width:100%;*/
            /*height:1800px;*/
            /*overflow:auto;*/
            }
            iframe {
            width: 1px;
            min-width: 100%;
            }
            .spinner {
            margin: 0 auto;
            width: 70px;
            text-align: center;
            }

            .spinner > div {
            width: 18px;
            height: 18px;
            background-color: #333;

            border-radius: 100%;
            display: inline-block;
            -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
            animation: sk-bouncedelay 1.4s infinite ease-in-out both;
            }

            .spinner .bounce1 {
            -webkit-animation-delay: -0.32s;
            animation-delay: -0.32s;
            }

            .spinner .bounce2 {
            -webkit-animation-delay: -0.16s;
            animation-delay: -0.16s;
            }

            @-webkit-keyframes sk-bouncedelay {
            0%, 80%, 100% { -webkit-transform: scale(0) }
            40% { -webkit-transform: scale(1.0) }
            }

            @keyframes sk-bouncedelay {
            0%, 80%, 100% {
            -webkit-transform: scale(0);
            transform: scale(0);
            } 40% {
            -webkit-transform: scale(1.0);
            transform: scale(1.0);
            }
            }

            </style>


            <script type="text/javascript">
            $(function(){
            var d=15,
                a=$("#preload").removeClass("hidden"),
                e=$(".frame-content iframe").addClass("hidden"),
                c=$(window),
                g=$("header"),
                f=$("footer"),
                b=$(".box.intro");

            setTimeout(function(){
                a.addClass("hidden");
                e.removeClass("hidden");
            },3000);

            c.resize(function(){
                e.height(c.height()-g.outerHeight(true)-f.outerHeight(true)-b.outerHeight(true)-d)
            }).resize()});
            </script>


            <div class="panel panel-default panel__job-detail">
                 <!-- Bannerbild -->
                 <div class="banner" style="background-image: url(<?= $imageServerUrl ?>)"></div>
                 <!-- End Bannerbild -->

                <div class="panel-body">
                    <!-- company logo and job title-->
                    <div class="teaser__job-detail">
                        <div itemprop="logo">
                            <div class="wrapper__logo">
                                <img src="<?= $logoUrl ?>" alt="<?= $orgName?>">
                            </div>
                        </div>
                        <h1><?=$job->getTitle()?></h1>
                    </div>
                    <!-- end company logo and job title-->

                    <!-- expired info box -->
                    <?= $this->partial('jobs/partials/expired-info.phtml', ['isExpired' => $isExpired]); ?>
                    <!-- end expired info box -->

                    <div class="job-short-info">
                        <ul>
                            <li class="location">
                                <!-- location -->
                                <?php
                                $location = $job->getLocations()->current();
                                if ($location == '') {
                                    echo $this->translate('Swiss');
                                }
                                else {
                                    echo $location ? (($location->getCity()) ? $location->getCity() : $location->getCountry()) :
                                        preg_replace('~\(.*?\)$~', '', (string) $job->getLocation());
                                }
                                ?>
                                <!-- end location -->
                            </li>
                            <li class="company">
                                <!-- company name -->
                                <?php if ($org && !$orgIsDisabled): ?>
                                    <a title="Jobs <?= ($org->getOrganizationName()) ? $org->getOrganizationName()->getName() : $orgName ?>" href="<?= $this->orgProfileUrl($org)?>?clear=1"><?= $orgName ?></a>
                                <?php else: ?>
                                    <strong><?= ($org && $org->getOrganizationName()) ? $org->getOrganizationName()->getName() : $orgName ?></strong>
                                <?php endif ?>
                                <!-- end company name -->
                            </li>
                            <li class="type">
                                <!-- type of contract -->
                                <?php
                                $typeOfContract = $job->getClassifications()->getEmploymentTypes()->__toString() ?:'Vollzeit' ?>
                                <span class="yk-contract yk-<?=$typeOfContract?>"><?=$typeOfContract; ?></span>
                                <!-- end type of contract -->
                            </li>
                            <li class="date">
                                <!-- published date -->
                                <span><?= $this->publishDateFormatter($job) ?></span>
                                <!-- end published date -->
                            </li>
                            <?php if ($industries->getItems()->count() && !$this->isCrawlerJob($org)): ?>
                                <li class="industries">
                                    <?= $industries->__toString(); ?>
                                </li>
                            <?php endif; ?>
                        </ul>

                        <!-- favorite button -->
                        <?= $this->partial('jobs/partials/favorite-button.phtml', [
                            'jobId' => $job->getId(),
                            'isExpired' => $isExpired,
                            'buttonCss' => 'hidden-xs',
                        ]); ?>
                        <!-- end favorite button -->
                    </div>

                    <hr class="job-details-devider"/>

                    <div class="apply-button-group">
                        <!-- apply button -->
                        <?= $this->partial('jobs/partials/apply-button.phtml', [
                            'preview' => $preview,
                            'isExpired' => $isExpired,
                            'job' => $this->job,
                        ]); ?>
                        <!-- end apply button -->

                        <!-- favorite button -->
                        <?= $this->partial('jobs/partials/favorite-button.phtml', [
                            'jobId' => $job->getId(),
                            'isExpired' => $isExpired,
                            'buttonCss' => 'visible-xs favorite-button',
                        ]); ?>
                        <!-- end favorite button -->
                    </div>

                    <div class="embed-container">
                        <div class="frame-content">
                            <div id="preload" class="loading hidden text-center">
                                <div class="spinner">
                                    <div class="bounce1"></div>
                                    <div class="bounce2"></div>
                                    <div class="bounce3"></div>
                                </div>
                                <p>Das Inserat wird geladen, bitte haben Sie einem Moment Geduld</p>
                            </div>
                            <?php if(strpos($link, '.pdf') !== false): ?>
                                <iframe style="height:122rem" id="iframePdf" src="<?=$link?>"></iframe>
                            <?php else: ?>
                                <iframe style="height:2500px" id="iframe4" src="<?=$link?>"></iframe>
                            <?php endif; ?>
                        </div>
                    </div>

                    <div class="apply-button-group">
                        <!-- apply button -->
                        <?= $this->partial('jobs/partials/apply-button.phtml', [
                            'preview' => $preview,
                            'isExpired' => $isExpired,
                            'job' => $this->job,
                        ]); ?>
                        <!-- end apply button -->

                        <!-- favorite button -->
                        <?= $this->partial('jobs/partials/favorite-button.phtml', [
                            'jobId' => $job->getId(),
                            'isExpired' => $isExpired,
                            'buttonCss' => 'visible-xs favorite-button',
                        ]); ?>
                        <!-- end favorite button -->
                    </div>

                    
                    <p class="text-center">Bitte beziehen Sie sich bei Ihrer Bewerbung auf <strong>gastrojob24.ch</strong>.</p>
 
 
 

                    <hr class="job-details-devider"/>

                    <!-- share buttons -->
                    <div class="text-center">Diesen Job teilen: </div>
                    <div id="share" class="text-center round-shares"></div>
                    <div class="clearfix"></div>
                    <!-- end share buttons -->

                    <!-- similar jobs -->
                    <?php if (!$preview): ?>
                        <?php echo $this->partial('jobs/partials/similar-jobs.phtml', [
                            'job' => $this->job
                        ]);
                        ?>
                    <?php endif; ?>
                    <!-- end similar jobs -->

                    <?php if (!$preview): ?>
                    <!-- recommended jobs
                    <div class="grey-description-container">
                        <div class="content">
                            <div class="headline">Empfohlene Jobs</div>
                            <div class="content__inner">

                            </div>
                        </div>
                    </div>
                    end recommended jobs -->

                    <!-- recommended jobs by cities
                    <div class="grey-description-container">
                        <div class="content">
                            <div class="headline">Jobs nach Städten</div>
                            <div class="content__inner">

                            </div>
                        </div>
                    </div>
                     end recommended jobs by cities -->
                <?php endif; ?>
                </div>
            </div>

            <!-- socials -->
            <script src="/modules/Gastro24/jssocials-1.4.0/dist/jssocials.js"></script>
            <script>
            $("#share").jsSocials({
            showLabel: false,
            showCount: true,
            shares: ["email", "twitter", "facebook", "whatsapp"]
            });
            </script>
            <!-- end socials -->

            <!-- iframe resizer -->
            <?php $this->configHeadScript()->appendScript('iFrameResize({ log: false }, "#iframe4")'); ?>
            <!-- end iframe resizer -->

        <?php endif; ?>

        <?php if ($this->isIntern):?>
            <?= $this->internalJob ?>
        <?php endif ?>

    </div>
</div>

<!-- apply modal -->
<div class="modal fade" id="job-apply-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" style="width: 90%; max-width:1200px; height: 90%" role="document">
        <div class="modal-content" style="height: 100%">
            <div class="modal-body" style="height: calc(100% - 65px)"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Schliessen</button>
            </div>
        </div>
    </div>
</div>
<!-- end apply modal -->
